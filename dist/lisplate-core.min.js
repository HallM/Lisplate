/*! lisplate - v0.3.0
* https://github.com/HallM/lisplate
* Copyright (c) 2016 ; Released under the MIT License */
!function(a,b){"function"==typeof define&&define.amd&&define.amd.dust===!0?define("lisplate.compiler",[],b):"object"==typeof exports?module.exports=b():a.lisplateCompiler=b()}(this,function(){return function(){throw new Error("Compiler is not in the core build")}}),function(a,b){"function"==typeof define&&define.amd&&define.amd.dust===!0?define("lisplate.utils",[],b):"object"==typeof exports?module.exports=b():a.lisplateUtils=b()}(this,function(){"use strict";return{resolve:function(a){return"function"==typeof a?a():a},thenable:function(a){return"object"==typeof a&&"function"==typeof a.then}}}),function(a,b){"function"==typeof define&&define.amd&&define.amd.dust===!0?define("lisplate.runtime",["lisplate.utils"],b):"object"==typeof exports?module.exports=b(require("./util")):a.lisplateRuntime=b(a.lisplateUtils)}(this,function(a){"use strict";function b(a){return h[a]}function c(){this.current="",this.stack=[],this.lastFlushedIndex=0,this.thenables=[],this.isAsync=!1,this.lastWasAsync=!1}var d=a.resolve,e=a.thenable,f=/[&<>\"\']/,g=/[&<>\"\']/g,h={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"},i={escapeHtml:function(a){return"string"!=typeof a?a:f.test(a)?a.replace(g,b):a},not:function(a){return!d(a)},eq:function(a,b){return d(a)===d(b)},lt:function(a,b){return d(a)<d(b)},gt:function(a,b){return d(a)>d(b)},lte:function(a,b){return d(a)<=d(b)},gte:function(a,b){return d(a)>=d(b)},cmpand:function(a,b){return d(a)&&d(b)},cmpor:function(a,b){return d(a)||d(b)},add:function(a,b){return d(a)+d(b)},sub:function(a,b){return d(a)-d(b)},mul:function(a,b){return d(a)*d(b)},div:function(a,b){return d(a)/d(b)},mod:function(a,b){return d(a)%d(b)},each:function(a,b,f){var g=d(a);if(e(g))return g.then(function(a){return i.each(a,b,f)});var h=0;if(g&&(h=g.length)){if(b){for(var j=new c,k=0;k<h;k++)"function"==typeof b?j.w(b(g[k],k)):j.w(b);return j.getOutput()}}else if(f)return d(f);return""},"if":function(a,b,c){var f=d(a);if(e(f))return f.then(function(a){return i["if"](a,b,c)});if(f){if(b)return d(b)}else if(c)return d(c);return""},isEmpty:function(a){var b=d(a);return 0!==b&&(!(!Array.isArray(b)||b.length)||!b)},isNotEmpty:function(a){return!i.isEmpty(a)}};return c.prototype.w=function(a){var b=d(a);if(null!=b)if(e(b)){this.current.length&&(this.stack.push(this.current),this.current=""),this.isAsync=!0,this.lastWasAsync=!0;var c=this.stack.length;this.stack.push("");var f=this,g=b.then(function(a){f.stack[c]=a});this.thenables.push(g)}else this.lastWasAsync?this.current=b:this.current+=b,this.lastWasAsync=!1},c.prototype.getOutput=function(){var a=this;return a.isAsync?(a.current.length&&a.stack.push(a.current),Promise.all(a.thenables).then(function(){return a.stack.join("")})):a.current},i.$W=c,i}),function(a,b){"function"==typeof define&&define.amd&&define.amd.dust===!0?define("lisplate.core",["lisplate.compiler","lisplate.runtime","lisplate.utils"],b):"object"==typeof exports?module.exports=b(require("./compiler"),require("./runtime"),require("./util")):a.Lisplate=b(a.lisplateCompiler,a.lisplateRuntime,a.lisplateUtils)}(this,function(compiler,runtime,utils){"use strict";function _callbackify(a){var b=a.length;return function(){var c=arguments.length,d=c>b?arguments[c-1]:null,e=null;"function"==typeof d?e=Array.prototype.slice.call(arguments,0,c-1):(e=Array.prototype.slice.call(arguments,0,c),d=null);var f=a.apply(this,e);return _thenable(f)?d?void f.then(function(a){d(null,a)})["catch"](function(a){d(a)}):f:d?void d(null,f):f}}function _promisifyPossibleAsync(a){if(!a)return a;var b=a.length;return function(){var c=Array.prototype.slice.apply(arguments),d=c.length;return b===d+1?new Promise(function(b,d){c.push(function(a,c){return a?void d(a):void b(c)}),a.apply(null,c)}):Promise.resolve(a.apply(null,c))}}function Lisplate(a){a||(a={}),this.cacheEnabled=!(a.cacheEnabled===!1),this.sourceLoader=_promisifyPossibleAsync(a.sourceLoader),this.viewModelLoader=_promisifyPossibleAsync(a.viewModelLoader),this.stringsLoader=_promisifyPossibleAsync(a.stringsLoader),this.helpers={},this.cache={}}var _thenable=utils.thenable;return Lisplate.prototype.addHelper=function(a,b){this.helpers[a]=b},Lisplate.prototype.loadTemplate=_callbackify(function(a){var b=this;return a?"function"==typeof a?Promise.resolve(a):b.cache[a]?Promise.resolve(b.cache[a]):b.sourceLoader?b.sourceLoader(a).then(function(c){return b.compileFn(a,c)}):Promise.reject(new Error("Must define a sourceLoader")):Promise.reject(new Error("Must specify a template to load"))}),Lisplate.prototype.compileFn=_callbackify(function(a,b){var c=this,d=null,e=null;try{d=c.compile(a,b),e=c.loadCompiledSource(d)}catch(f){return Promise.reject(f)}var g=null;return g=c.viewModelLoader?c.viewModelLoader(a):Promise.resolve(null),g.then(function(b){var d=e(b);return d.templateName=a,c.cache[a]=d,d})}),Lisplate.prototype.compile=compiler,Lisplate.prototype.loadCompiledSource=function loadCompiledSource(compiledSource){var template=null;return eval("template="+compiledSource),template},Lisplate.prototype.render=_callbackify(function(a,b){var c=this;return c.stringsLoader?c.stringsLoader(a.templateName).then(function(d){return a(c,b,d,runtime)}):a(c,b,null,runtime)}),Lisplate.prototype.renderTemplate=_callbackify(function(a,b){var c=this;return c.loadTemplate(a).then(function(a){return c.render(a,b)})}),Lisplate});