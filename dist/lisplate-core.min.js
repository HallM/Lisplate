/*! lisplate - v0.6.0
* https://github.com/lisplate/lisplate
* Copyright (c) 2016 ; Released under the MIT License */
!function(a,b){"function"==typeof define&&define.amd?define("lisplate.utils",[],b):"object"==typeof exports?module.exports=b():(a.Lisplate={},a.Lisplate.Utils=b())}(this,function(){"use strict";return{loadCompiledSource:function loadCompiledSource(compiledSource){var template=null;return eval("template="+compiledSource),template},resolve:function(a){return"function"==typeof a?a():a},thenable:function(a){return("object"==typeof a||"function"==typeof a)&&"function"==typeof a.then}}}),function(a,b){"function"==typeof define&&define.amd?define("lisplate.runtime",["lisplate.utils"],b):"object"==typeof exports?module.exports=b(require("./util")):a.Lisplate.Runtime=b(a.Lisplate.Utils)}(this,function(a){"use strict";function b(a){var b=i[a];return function(a){return b[a]}}function c(a){var b=g[a],c=h[a],d=j[a],e=function(a){return f(a)?a.then(function(a){return e(a)}):b.test(a)?a.replace(c,d):a};return e}function d(){this.current="",this.stack=[],this.lastFlushedIndex=0,this.thenables=[],this.isAsync=!1,this.lastWasAsync=!1}var e=a.resolve,f=a.thenable,g={html:/[&<>\"\']/,js:/[\\\/\r\n\f\t'"\u2028\u2029]/,json:/["<\u2028\u2029]/},h={html:/[&<>\"\']/g,js:/[\\\/\r\n\f\t'"\u2028\u2029]/g,json:/["<\u2028\u2029]/g},i={html:{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"},js:{"\\":"\\\\","/":"\\/","\r":"\\r","\n":"\\n","\f":"\\f","\t":"\\t","'":"\\'",'"':'\\"',"\u2028":"\\u2028","\u2029":"\\u2029"},json:{'"':'\\"',"<":"\\u003c","\u2028":"\\u2029","\u2029":"\\u2029"}},j={html:b("html"),js:b("js"),json:b("json")},k={escapeHtml:c("html"),escapeJs:c("js"),escapeJson:c("json"),get:function(a,b){return b?a[b]:a},not:function(a){return!a},eq:function(a,b){return a===b},neq:function(a,b){return a!==b},lt:function(a,b){return a<b},gt:function(a,b){return a>b},lte:function(a,b){return a<=b},gte:function(a,b){return a>=b},cmpand:function(a,b){return a&&b},cmpor:function(a,b){return a||b},add:function(a,b){return a+b},sub:function(a,b){return a-b},mul:function(a,b){return a*b},div:function(a,b){return a/b},mod:function(a,b){return a%b},each:function(a,b,c){var g=a;if(f(g))return g.then(function(a){return k.each(a,b,c)});var h=0;if(g&&(h=g.length)){if(b){for(var i=new d,j=0;j<h;j++)"function"==typeof b?i.w(b(g[j],j)):i.w(b);return i.getOutput()}}else if(c)return e(c);return""},"if":function(a,b,c){var d=a;if(f(d))return d.then(function(a){return k["if"](a,b,c)});if(d){if(b)return e(b)}else if(c)return e(c);return""},isEmpty:function(a){var b=a;return 0!==b&&(!(!Array.isArray(b)||b.length)||!b)},isNotEmpty:function(a){return!k.isEmpty(a)}};return d.prototype.w=function(a){var b=a;if(null!=b)if(b instanceof d&&(b=b.getOutput()),f(b)){this.current.length&&(this.stack.push(this.current),this.current=""),this.isAsync=!0,this.lastWasAsync=!0;var c=this.stack.length;this.stack.push("");var e=this,g=b.then(function(a){e.stack[c]=a});this.thenables.push(g)}else this.lastWasAsync?this.current=b:this.current+=b,this.lastWasAsync=!1},d.prototype.getOutput=function(){var a=this;return a.isAsync?(a.current.length&&a.stack.push(a.current),Promise.all(a.thenables).then(function(){return a.stack.join("")})):a.current},k.Chunk=d,k}),function(a,b){"function"==typeof define&&define.amd?define("lisplate.core",["lisplate.runtime","lisplate.utils"],b):"object"==typeof exports?module.exports=b(require("./runtime"),require("./util")):a.Lisplate=b(a.Lisplate.Runtime,a.Lisplate.Utils)}(this,function(a,b){"use strict";function c(a){return function(){var b=arguments.length,c=b?arguments[b-1]:null,d=null;"function"==typeof c?d=Array.prototype.slice.call(arguments,0,b-1):(d=Array.prototype.slice.call(arguments,0,b),c=null);var f=a.apply(this,d);return e(f)?c?void f.then(function(a){c(null,a)})["catch"](function(a){c(a)}):f:c?void c(null,f):f}}function d(a){var b=a.length;return function(){var c=Array.prototype.slice.apply(arguments),d=c.length;return b===d+1?new Promise(function(b,d){c.push(function(a,c){return a?void d(a):void b(c)}),a.apply(null,c)}):Promise.resolve(a.apply(null,c))}}function Lisplate(a){a||(a={}),this.cacheEnabled=!(a.cacheEnabled===!1),this.sourceLoader=a.sourceLoader,this.viewModelLoader=a.viewModelLoader,this.stringsLoader=a.stringsLoader,this.compilerOptions=a.compilerOptions,this.helpers={},this.cache={}}var e=b.thenable;return Lisplate.Runtime=a,Lisplate.Utils=b,Lisplate.FactoryCache={},Lisplate.prototype.addHelper=function(a,b){this.helpers[a]=b},Lisplate.prototype.loadTemplate=c(function(a){var b=this;if(!a)return Promise.reject(new Error("Must specify template information to load"));var c="string"==typeof a?a:a.templateName,e=a.renderFactory;if(""===c)return Promise.reject(new Error("Must specify a valid template name to load"));if(e)e=Promise.resolve(e);else{if(b.cacheEnabled&&b.cache[c])return Promise.resolve(b.cache[c]);if(b.cacheEnabled&&Lisplate.FactoryCache[c])e=Promise.resolve(Lisplate.FactoryCache[c]);else{if(!b.sourceLoader)return Promise.reject(new Error("Must define a sourceLoader"));if(!Lisplate.Compiler||!Lisplate.Compiler.compile)return Promise.reject("Compiler is not loaded to compile loaded source");e=d(b.sourceLoader)(c).then(function(a){var d=null,e=null;try{d=Lisplate.Compiler.compile(c,a,b.compilerOptions),e=Lisplate.Utils.loadCompiledSource(d)}catch(f){return Promise.reject(f)}return Promise.resolve(e)})}}return e.then(function(a){b.cacheEnabled&&(Lisplate.FactoryCache[c]=a);var e=null;return e=b.viewModelLoader?d(b.viewModelLoader)(c):Promise.resolve(null),e.then(function(d){var e=a(b,d);return e.templateName=c,b.cacheEnabled&&(b.cache[c]=e),e})})}),Lisplate.prototype.render=c(function(a,b,c){var e=this;return e.stringsLoader?d(e.stringsLoader)(a.templateName,c).then(function(d){return a(b,d,Lisplate.Runtime,c)}):a(b,null,Lisplate.Runtime,c)}),Lisplate.prototype.renderTemplate=c(function(a,b,c){var d=this;return d.loadTemplate(a).then(function(a){return d.render(a,b,c)})}),Lisplate});